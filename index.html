<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Associatif et Jeunesse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-cell {
            background-color: white;
            min-height: 120px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        @media (max-width: 768px) {
            .calendar-cell { min-height: 80px; padding: 0.25rem; }
            .event-pill { font-size: 0.65rem; padding: 0.1rem 0.25rem; }
        }
        .event-pill {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .event-pill:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 p-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-xl md:text-2xl font-bold text-indigo-700">
                <i class="fa-regular fa-calendar-days mr-2"></i>Planning Collectivité
            </h1>
            <span id="role-badge" class="hidden px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-bold uppercase tracking-wide">Public</span>
        </div>
        
        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex items-center gap-2">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
                <h2 id="current-month-display" class="text-lg md:text-xl font-semibold w-40 text-center capitalize">Janvier 2026</h2>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="current-filter-display" class="hidden md:inline-block px-3 py-1 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-md text-sm font-medium">
                    Filtre: Tous
                </span>
                <button onclick="showFilterModal()" class="md:hidden p-2 text-indigo-600 hover:bg-indigo-50 rounded-md" title="Changer de filtre">
                    <i class="fa-solid fa-filter"></i>
                </button>
                <button id="btn-add-event" onclick="openEventForm()" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition shadow-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Nouvelle Activité
                </button>
            </div>
        </div>
    </header>

    <!-- Calendar Area -->
    <main class="flex-1 overflow-auto p-2 md:p-6">
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Days header -->
            <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Lun</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Mar</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Mer</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Jeu</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Ven</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Sam</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-600">Dim</div>
            </div>
            <!-- Calendar Grid -->
            <div id="calendar-body" class="calendar-grid">
                <!-- Cells generated by JS -->
            </div>
        </div>
    </main>

    <!-- Hidden Login Trigger (10x10 px bottom right) -->
    <div onclick="openLoginModal()" style="position:fixed; bottom:0; right:0; width:10px; height:10px; cursor:default; z-index:9999;"></div>

    <!-- MODALS -->
    
    <!-- 1. Filter Selection Modal (Shown on load) -->
    <div id="modal-filter" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-xl shadow-xl p-6 md:p-8 max-w-md w-full mx-4 transform transition-all">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Bienvenue</h2>
            <p class="text-gray-600 mb-6">Veuillez sélectionner le planning que vous souhaitez consulter :</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="filter-options">
                <!-- Buttons generated by JS -->
            </div>
        </div>
    </div>

    <!-- 2. Login Modal -->
    <div id="modal-login" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Accès Restreint</h3>
                <button onclick="closeModal('modal-login')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Identifiant</label>
                    <input type="text" id="login-id" class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="login-pwd" class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden">Identifiant ou mot de passe incorrect.</div>
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white font-medium py-2 rounded-md hover:bg-indigo-700 transition">Se connecter</button>
                <button onclick="logout()" id="btn-logout" class="hidden w-full bg-gray-200 text-gray-800 font-medium py-2 rounded-md hover:bg-gray-300 transition mt-2">Se déconnecter (Retour Public)</button>
            </div>
        </div>
    </div>

    <!-- 3. Event Form Modal (Association / Admin) -->
    <div id="modal-event" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto pt-10 pb-10">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="event-form-title">Nouvelle Activité</h3>
                <button onclick="closeModal('modal-event')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form id="form-event" onsubmit="saveEvent(event)" class="space-y-4">
                <input type="hidden" id="ev-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la structure *</label>
                    <input type="text" id="ev-structure" required placeholder="Ex: Centre de loisirs Oxygen" class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tranche d'âge *</label>
                    <select id="ev-age" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Sélectionner...</option>
                        <option value="0-6 ans">0-6 ans</option>
                        <option value="3-6 ans">3-6 ans</option>
                        <option value="6-10 ans">6-10 ans</option>
                        <option value="ado">Ado</option>
                        <option value="adulte">Adulte</option>
                        <option value="parentalité">Parentalité</option>
                        <option value="vie associative">Vie associative</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'action *</label>
                    <input type="text" id="ev-action" required placeholder="Ex: Sortie accrobranche" class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de début *</label>
                        <input type="date" id="ev-start-date" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Heure de début *</label>
                        <input type="time" id="ev-start-time" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin *</label>
                        <input type="date" id="ev-end-date" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Heure de fin *</label>
                        <input type="time" id="ev-end-time" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t">
                    <button type="button" onclick="closeModal('modal-event')" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Annuler</button>
                    <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Event Details Modal (Public, Admin) -->
    <div id="modal-details" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-gray-800 pr-4" id="det-action">Nom de l'action</h3>
                <button onclick="closeModal('modal-details')" class="text-gray-400 hover:text-gray-600 mt-1"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-3 text-sm text-gray-600 mb-6">
                <p><i class="fa-solid fa-building w-5 text-indigo-500"></i> <strong class="text-gray-800">Structure:</strong> <span id="det-structure"></span></p>
                <p><i class="fa-solid fa-users w-5 text-indigo-500"></i> <strong class="text-gray-800">Public visé:</strong> <span id="det-age"></span></p>
                <p><i class="fa-solid fa-clock w-5 text-indigo-500"></i> <strong class="text-gray-800">Période:</strong> <span id="det-time"></span></p>
                
                <div id="det-bilan-section" class="mt-4 pt-4 border-t border-gray-100 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Bilan de l'action</h4>
                    <p><strong>Public touché:</strong> <span id="det-public-count">-</span></p>
                    <p><strong>Partenaires:</strong> <span id="det-partners">-</span></p>
                    <p><strong>Évaluation:</strong> <span id="det-evaluation">-</span>/10</p>
                </div>
            </div>

            <div id="det-admin-actions" class="hidden pt-4 border-t border-gray-200 flex flex-wrap gap-2 justify-end">
                <button onclick="editEvent()" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-sm font-medium"><i class="fa-solid fa-pen mr-1"></i> Modifier</button>
                <button onclick="clearBilan()" class="px-3 py-1.5 bg-yellow-50 text-yellow-600 rounded hover:bg-yellow-100 text-sm font-medium"><i class="fa-solid fa-eraser mr-1"></i> Effacer Bilan</button>
                <button onclick="deleteEvent()" class="px-3 py-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm font-medium"><i class="fa-solid fa-trash mr-1"></i> Supprimer</button>
            </div>
            <div id="det-bilan-actions" class="hidden pt-4 border-t border-gray-200 flex justify-end">
                <button onclick="openBilanForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium"><i class="fa-solid fa-clipboard-check mr-1"></i> Renseigner le bilan</button>
            </div>
        </div>
    </div>

    <!-- 5. Bilan Form Modal (Bilan / Admin) -->
    <div id="modal-bilan" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Bilan de l'action</h3>
                <button onclick="closeModal('modal-bilan')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4" id="bilan-action-name">Action: ...</p>
            <form id="form-bilan" onsubmit="saveBilan(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Public touché (nombre)</label>
                    <input type="number" id="bilan-count" min="0" class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Partenaires de l'action</label>
                    <textarea id="bilan-partners" rows="2" class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 focus:border-green-500" placeholder="Noms des partenaires..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Évaluation (0 à 10)</label>
                    <input type="number" id="bilan-eval" min="0" max="10" required class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="pt-4 flex justify-end gap-3 border-t">
                    <button type="button" onclick="closeModal('modal-bilan')" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Annuler</button>
                    <button type="submit" class="px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700">Valider le bilan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert / Message Box -->
    <div id="message-box" class="fixed top-4 right-4 bg-white border-l-4 rounded shadow-lg p-4 transform transition-transform translate-x-full z-[100] max-w-sm flex items-center justify-between">
        <div class="flex items-center">
            <i id="msg-icon" class="mr-3 text-lg"></i>
            <span id="msg-text" class="text-gray-800 text-sm font-medium"></span>
        </div>
        <button onclick="closeMessage()" class="ml-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const AGE_GROUPS = [
            { id: "0-6 ans", label: "0-6 ans", color: "bg-blue-500" },
            { id: "3-6 ans", label: "3-6 ans", color: "bg-cyan-500" },
            { id: "6-10 ans", label: "6-10 ans", color: "bg-green-500" },
            { id: "ado", label: "Ado", color: "bg-yellow-500" },
            { id: "adulte", label: "Adulte", color: "bg-purple-500" },
            { id: "parentalité", label: "Parentalité", color: "bg-pink-500" },
            { id: "vie associative", label: "Vie associative", color: "bg-orange-500" }
        ];

        // --- STATE ---
        let state = {
            role: 'public', // 'public', 'asso', 'bilan', 'admin'
            filter: null, // null means unselected. 'tous' or specific age group.
            currentDate: new Date(), // Used to determine which month to show
            events: [],
            selectedEventId: null // Used for modals
        };

        // Mock data initialization
        function initMockData() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            
            state.events = [
                {
                    id: 'evt-1',
                    structure: 'Oxygen',
                    ageGroup: '3-6 ans',
                    action: 'Atelier Peinture',
                    startDate: `${y}-${m}-10`, startTime: '10:00',
                    endDate: `${y}-${m}-10`, endTime: '12:00',
                    publicCount: null, partners: '', evaluation: null
                },
                {
                    id: 'evt-2',
                    structure: 'MJC Locale',
                    ageGroup: 'ado',
                    action: 'Tournoi e-sport',
                    startDate: `${y}-${m}-15`, startTime: '14:00',
                    endDate: `${y}-${m}-16`, endTime: '18:00',
                    publicCount: 45, partners: 'Mairie, Asso Gaming', evaluation: 9
                }
            ];
        }

        // --- INIT ---
        window.onload = () => {
            initMockData();
            renderFilterOptions();
            
            // Check if filter is selected, else show modal
            if (!state.filter) {
                document.getElementById('modal-filter').classList.remove('hidden');
            } else {
                updateUI();
            }
        };

        // --- UI UPDATES ---
        function updateUI() {
            renderHeader();
            renderCalendar();
            updateRoleUI();
        }

        function renderHeader() {
            const display = document.getElementById('current-month-display');
            const options = { month: 'long', year: 'numeric' };
            display.textContent = state.currentDate.toLocaleDateString('fr-FR', options);
            
            const filterDisplay = document.getElementById('current-filter-display');
            if (state.filter) {
                filterDisplay.classList.remove('hidden');
                filterDisplay.textContent = `Filtre: ${state.filter === 'tous' ? 'Tous les plannings' : state.filter}`;
            }
        }

        function updateRoleUI() {
            const roleBadge = document.getElementById('role-badge');
            const btnAdd = document.getElementById('btn-add-event');
            
            roleBadge.classList.remove('hidden', 'bg-gray-200', 'bg-blue-200', 'bg-green-200', 'bg-red-200');
            
            if (state.role === 'admin') {
                roleBadge.textContent = 'Admin';
                roleBadge.classList.add('bg-red-200', 'text-red-800');
                btnAdd.classList.remove('hidden');
            } else if (state.role === 'asso') {
                roleBadge.textContent = 'Association';
                roleBadge.classList.add('bg-blue-200', 'text-blue-800');
                btnAdd.classList.remove('hidden');
            } else if (state.role === 'bilan') {
                roleBadge.textContent = 'Bilan';
                roleBadge.classList.add('bg-green-200', 'text-green-800');
                btnAdd.classList.add('hidden');
            } else {
                roleBadge.textContent = 'Public';
                roleBadge.classList.add('bg-gray-200', 'text-gray-800');
                btnAdd.classList.add('hidden');
            }
        }

        // --- CALENDAR LOGIC ---
        function changeMonth(delta) {
            state.currentDate.setMonth(state.currentDate.getMonth() + delta);
            updateUI();
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function renderCalendar() {
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth(); // 0-11
            
            const firstDay = new Date(year, month, 1);
            // Convert Sunday=0 to Monday=0
            let startDayOfWeek = firstDay.getDay() - 1;
            if (startDayOfWeek === -1) startDayOfWeek = 6; 
            
            const daysInMonth = getDaysInMonth(year, month);
            
            // Previous month padding
            for (let i = 0; i < startDayOfWeek; i++) {
                body.appendChild(createCell(null));
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                body.appendChild(createCell(day, dateStr));
            }
            
            // Next month padding to complete grid
            const totalCells = startDayOfWeek + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remaining; i++) {
                body.appendChild(createCell(null));
            }
        }

        function createCell(dayNumber, dateStr) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            
            if (dayNumber) {
                // Day number
                const dayLabel = document.createElement('div');
                dayLabel.className = 'text-right text-sm font-semibold text-gray-700 mb-1';
                
                // Highlight today
                const today = new Date();
                if (today.getDate() === dayNumber && today.getMonth() === state.currentDate.getMonth() && today.getFullYear() === state.currentDate.getFullYear()) {
                    dayLabel.innerHTML = `<span class="bg-indigo-600 text-white rounded-full w-6 h-6 inline-flex items-center justify-center">${dayNumber}</span>`;
                } else {
                    dayLabel.textContent = dayNumber;
                }
                cell.appendChild(dayLabel);
                
                // Add events for this day
                const dayEvents = getEventsForDate(dateStr);
                dayEvents.forEach(evt => {
                    const pill = document.createElement('div');
                    const groupConfig = AGE_GROUPS.find(g => g.id === evt.ageGroup);
                    const colorClass = groupConfig ? groupConfig.color : 'bg-gray-500';
                    
                    pill.className = `event-pill ${colorClass}`;
                    pill.title = `${evt.structure} : ${evt.action}`;
                    
                    // Format text inside pill
                    const hasBilan = evt.evaluation !== null && evt.evaluation !== "";
                    const icon = hasBilan ? '<i class="fa-solid fa-check-circle text-[10px] mr-1 opacity-80"></i>' : '';
                    pill.innerHTML = `${icon}<strong>${evt.structure}</strong>: ${evt.action}`;
                    
                    pill.onclick = (e) => {
                        e.stopPropagation();
                        openEventDetails(evt.id);
                    };
                    
                    cell.appendChild(pill);
                });
            } else {
                cell.classList.add('bg-gray-50');
            }
            
            return cell;
        }

        function getEventsForDate(dateStr) {
            return state.events.filter(evt => {
                // Apply global filter
                if (state.filter !== 'tous' && evt.ageGroup !== state.filter) {
                    return false;
                }
                // Check if dateStr is within event date range
                return dateStr >= evt.startDate && dateStr <= evt.endDate;
            }).sort((a, b) => a.startTime.localeCompare(b.startTime));
        }

        // --- FILTERS ---
        function renderFilterOptions() {
            const container = document.getElementById('filter-options');
            container.innerHTML = '';
            
            const allOptions = [...AGE_GROUPS, { id: 'tous', label: 'Tous les plannings', color: 'bg-gray-700' }];
            
            allOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-4 py-3 rounded-lg border-2 border-transparent bg-gray-50 hover:bg-gray-100 focus:outline-none transition flex items-center shadow-sm`;
                btn.innerHTML = `<span class="w-4 h-4 rounded-full ${opt.color} mr-3"></span> <span class="font-medium text-gray-800">${opt.label}</span>`;
                btn.onclick = () => selectFilter(opt.id);
                container.appendChild(btn);
            });
        }

        function selectFilter(filterId) {
            state.filter = filterId;
            document.getElementById('modal-filter').classList.add('hidden');
            updateUI();
        }

        function showFilterModal() {
            document.getElementById('modal-filter').classList.remove('hidden');
        }

        // --- AUTH & LOGIN ---
        function openLoginModal() {
            document.getElementById('modal-login').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-id').value = '';
            document.getElementById('login-pwd').value = '';
            
            if (state.role !== 'public') {
                document.getElementById('btn-logout').classList.remove('hidden');
            } else {
                document.getElementById('btn-logout').classList.add('hidden');
            }
        }

        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pwd = document.getElementById('login-pwd').value.trim();
            
            if (id === 'association' && pwd === 'CCMVR2025') {
                state.role = 'asso';
                finishLogin();
            } else if (id === 'bilan' && pwd === 'BILAN2026') {
                state.role = 'bilan';
                finishLogin();
            } else if (id === 'admin' && pwd === 'MAJA') {
                state.role = 'admin';
                finishLogin();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function finishLogin() {
            closeModal('modal-login');
            showMessage("Connexion réussie", "success");
            updateUI();
        }

        function logout() {
            state.role = 'public';
            closeModal('modal-login');
            showMessage("Déconnexion réussie", "info");
            updateUI();
        }

        // --- MODAL UTILS ---
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- EVENT FORMS (Add/Edit) ---
        function openEventForm(eventId = null) {
            state.selectedEventId = eventId;
            const title = document.getElementById('event-form-title');
            const form = document.getElementById('form-event');
            
            if (eventId) {
                title.textContent = "Modifier l'activité";
                const evt = state.events.find(e => e.id === eventId);
                document.getElementById('ev-id').value = evt.id;
                document.getElementById('ev-structure').value = evt.structure;
                document.getElementById('ev-age').value = evt.ageGroup;
                document.getElementById('ev-action').value = evt.action;
                document.getElementById('ev-start-date').value = evt.startDate;
                document.getElementById('ev-start-time').value = evt.startTime;
                document.getElementById('ev-end-date').value = evt.endDate;
                document.getElementById('ev-end-time').value = evt.endTime;
            } else {
                title.textContent = "Nouvelle Activité";
                form.reset();
                document.getElementById('ev-id').value = '';
                // Default dates to current viewed month if possible
                const d = new Date(state.currentDate);
                d.setDate(1);
                const ds = d.toISOString().split('T')[0];
                document.getElementById('ev-start-date').value = ds;
                document.getElementById('ev-end-date').value = ds;
            }
            
            // Hide details modal if open
            closeModal('modal-details');
            document.getElementById('modal-event').classList.remove('hidden');
        }

        function saveEvent(e) {
            e.preventDefault();
            
            const id = document.getElementById('ev-id').value;
            const newEvent = {
                id: id || 'evt-' + Date.now(),
                structure: document.getElementById('ev-structure').value,
                ageGroup: document.getElementById('ev-age').value,
                action: document.getElementById('ev-action').value,
                startDate: document.getElementById('ev-start-date').value,
                startTime: document.getElementById('ev-start-time').value,
                endDate: document.getElementById('ev-end-date').value,
                endTime: document.getElementById('ev-end-time').value,
                publicCount: null,
                partners: '',
                evaluation: null
            };

            // Basic validation: End date >= Start date
            if (newEvent.endDate < newEvent.startDate) {
                showMessage("La date de fin doit être après la date de début.", "error");
                return;
            }

            if (id) {
                // Update
                const idx = state.events.findIndex(e => e.id === id);
                // Preserve existing bilan info
                newEvent.publicCount = state.events[idx].publicCount;
                newEvent.partners = state.events[idx].partners;
                newEvent.evaluation = state.events[idx].evaluation;
                state.events[idx] = newEvent;
                showMessage("Activité modifiée", "success");
            } else {
                // Create
                state.events.push(newEvent);
                showMessage("Nouvelle activité ajoutée", "success");
            }
            
            closeModal('modal-event');
            updateUI();
        }

        // --- EVENT DETAILS ---
        function openEventDetails(eventId) {
            state.selectedEventId = eventId;
            const evt = state.events.find(e => e.id === eventId);
            if (!evt) return;

            document.getElementById('det-action').textContent = evt.action;
            document.getElementById('det-structure').textContent = evt.structure;
            document.getElementById('det-age').textContent = evt.ageGroup;
            
            const startStr = formatDateFR(evt.startDate) + ' ' + evt.startTime;
            const endStr = evt.startDate === evt.endDate ? evt.endTime : (formatDateFR(evt.endDate) + ' ' + evt.endTime);
            document.getElementById('det-time').textContent = `Du ${startStr} au ${endStr}`;

            // Bilan section visibility
            const bilanSec = document.getElementById('det-bilan-section');
            if (evt.evaluation !== null && evt.evaluation !== "") {
                bilanSec.classList.remove('hidden');
                document.getElementById('det-public-count').textContent = evt.publicCount || 'Non renseigné';
                document.getElementById('det-partners').textContent = evt.partners || 'Aucun';
                document.getElementById('det-evaluation').textContent = evt.evaluation;
            } else {
                bilanSec.classList.add('hidden');
            }

            // Actions visibility based on role
            const adminActions = document.getElementById('det-admin-actions');
            const bilanActions = document.getElementById('det-bilan-actions');
            
            adminActions.classList.add('hidden');
            bilanActions.classList.add('hidden');

            if (state.role === 'admin') {
                adminActions.classList.remove('hidden');
                // Admin can also add bilan if missing
                if (evt.evaluation === null || evt.evaluation === "") {
                    bilanActions.classList.remove('hidden');
                }
            } else if (state.role === 'bilan') {
                bilanActions.classList.remove('hidden');
            } else if (state.role === 'asso') {
                // Associations can't modify once created according to prompt, or maybe admin only?
                // "en tant qu'admin, aussi bien rajouter un nouvel événement que de supprimer... modifier".
                // I'll leave Asso without edit rights after creation to strictly follow requirements.
            }

            document.getElementById('modal-details').classList.remove('hidden');
        }

        // --- BILAN FORMS ---
        function openBilanForm() {
            const evt = state.events.find(e => e.id === state.selectedEventId);
            if (!evt) return;

            document.getElementById('bilan-action-name').textContent = `Action : ${evt.action} (${evt.structure})`;
            document.getElementById('bilan-count').value = evt.publicCount || '';
            document.getElementById('bilan-partners').value = evt.partners || '';
            document.getElementById('bilan-eval').value = evt.evaluation !== null ? evt.evaluation : '';

            closeModal('modal-details');
            document.getElementById('modal-bilan').classList.remove('hidden');
        }

        function saveBilan(e) {
            e.preventDefault();
            const evt = state.events.find(ev => ev.id === state.selectedEventId);
            if (!evt) return;

            evt.publicCount = document.getElementById('bilan-count').value || null;
            evt.partners = document.getElementById('bilan-partners').value;
            evt.evaluation = document.getElementById('bilan-eval').value;

            closeModal('modal-bilan');
            showMessage("Bilan enregistré avec succès", "success");
            updateUI();
        }

        // --- ADMIN ACTIONS ---
        function editEvent() {
            openEventForm(state.selectedEventId);
        }

        function deleteEvent() {
            // Replaced alert/confirm with direct action + message, or custom modal. 
            // For simplicity and rule adherence (no alert()), executing directly.
            state.events = state.events.filter(e => e.id !== state.selectedEventId);
            closeModal('modal-details');
            showMessage("Activité supprimée", "info");
            updateUI();
        }

        function clearBilan() {
            const evt = state.events.find(e => e.id === state.selectedEventId);
            if(evt) {
                evt.publicCount = null;
                evt.partners = '';
                evt.evaluation = null;
                closeModal('modal-details');
                showMessage("Bilan effacé", "info");
                updateUI();
            }
        }

        // --- UTILS ---
        function formatDateFR(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        // Custom Message Box (Toast)
        let messageTimeout;
        function showMessage(text, type = "info") {
            const box = document.getElementById('message-box');
            const icon = document.getElementById('msg-icon');
            const msgText = document.getElementById('msg-text');
            
            msgText.textContent = text;
            
            // Setup styles
            box.className = "fixed top-4 right-4 bg-white border-l-4 rounded shadow-lg p-4 transform transition-transform z-[100] max-w-sm flex items-center justify-between";
            icon.className = "mr-3 text-lg";
            
            if (type === "success") {
                box.classList.add("border-green-500");
                icon.classList.add("fa-solid", "fa-circle-check", "text-green-500");
            } else if (type === "error") {
                box.classList.add("border-red-500");
                icon.classList.add("fa-solid", "fa-circle-exclamation", "text-red-500");
            } else {
                box.classList.add("border-blue-500");
                icon.classList.add("fa-solid", "fa-circle-info", "text-blue-500");
            }

            // Show
            box.classList.remove("translate-x-full");
            
            // Auto hide
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                closeMessage();
            }, 4000);
        }

        function closeMessage() {
            document.getElementById('message-box').classList.add("translate-x-full");
        }

    </script>
</body>
</html>
